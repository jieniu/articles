(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{173:function(s,a,n){"use strict";n.r(a);var e=n(0),r=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"复制操作符怎么写"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#复制操作符怎么写","aria-hidden":"true"}},[s._v("#")]),s._v(" 复制操作符怎么写")]),s._v(" "),n("p",[s._v("C++ 中的操作符重载可以让我们的代码更符合人们的阅读习惯，而 "),n("code",[s._v("operator=")]),s._v(" 赋值操作符又是最常被重载的操作符。本篇主要谈到我们在写 "),n("code",[s._v("operator=")]),s._v(" 时可能会遇到的复制相同对象的问题，及我们该如何解决它。")]),s._v(" "),n("p",[s._v("对于「复制自己」，你肯定不会写这样的代码")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Dog a;\na = a;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("p",[s._v("但你可能会写这样的代码")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("dogs[i] = dogs[j];\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("而当 "),n("code",[s._v("i")]),s._v(" 和 "),n("code",[s._v("j")]),s._v(" 相等时，你便无意间写出了「复制自己」的代码，但到底「复制自己」会出现什么问题呢？先来看下下面这段代码：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("class Collar{};\nclass Dog {\n    Collar* pCollar;\n    \n    Dog& operator=(const Dog& rhs) {\n        delete pCollar;\n        pCollar = new Collar(*rhs.pCollar);\n        return *this;\n    }\n};\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("上面这段赋值操作符的实现，首先就把指针 "),n("code",[s._v("pCollar")]),s._v(" 给释放了，如果传入的对象就是自己，那么 "),n("code",[s._v("pCollar = new Collar(*rhs.pCollar)")]),s._v(" 这一行中的 "),n("code",[s._v("rhs.pCollar")]),s._v(" 就会引用一个被释放的指针，这会对程序造成灾难性的结果。")]),s._v(" "),n("p",[s._v("于是，为避免「复制自己」的问题，我们可以在 "),n("code",[s._v("delete")]),s._v(" 之前加一个条件判断，如下")]),s._v(" "),n("div",{staticClass:"language-c++ line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// ...\n    Dog& operator=(const Dog& rhs) {\n        if (this == &rhs) {\n            return *this;\n        }\n        \n        delete pCollar;\n        pCollar = new Collar(*rhs.pCollar);\n        return *this;\n    }\n// ... \n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("但这还没完，这里还有一个漏洞，如果 "),n("code",[s._v("new Collar(*rhs.pCollar)")]),s._v(" 抛出异常，则该对象的 "),n("code",[s._v("pCollar")]),s._v(" 由于被释放了，而变成了一个”野指针“，这也会给程序带来无法预期的结果。所以更为安全的写法是这样的：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// ...\n    Dog& operator=(const Dog& rhs) {\n        if (this == &rhs) {\n            return *this;\n        }\n        \n        Collar* pOriginCollar = pCollar;\n        pCollar = new Collar(*rhs.pCollar);\n        delete pOriginCollar;\n        return *this;\n    }\n// ...\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("可以看到，即便 "),n("code",[s._v("new Collar")]),s._v(" 抛出了异常，"),n("code",[s._v("pCollar")]),s._v(" 所指向的内容仍然不变。")]),s._v(" "),n("p",[s._v("此外，我们还有另外一种解决「复制自己」的方案，即面向对象中常用的委派（delegate），例如这里要复制的 "),n("code",[s._v("Collar")]),s._v(" 对象，不是在宿主 "),n("code",[s._v("Dog")]),s._v(" 对象中完成，而是把复制的动作委派给 "),n("code",[s._v("Collar")]),s._v("  的复制构造函数去完成，这样做的好处是各个类的代码各司其职，复杂度降低，更不易出错，如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("class Collar {\n    int price;\npublic:\n\tCollar &operator=(const Collar& rhs) {\n    \tif (this == &rhs) {\n        \treturn *this;\n    \t}\n    \tprice = rhs.price;\n    \treturn *this;\n\t}\n};\n\nclass Dog {\n    Collar* pCollar;\n    Dog& operator=(const Dog& rhs) {\n        *pCollar = *rhs.pCollar; // member by member copy of Collars\n        return *this;\n    }\n};\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("以上，请记住一点")]),s._v(" "),n("blockquote",[n("p",[s._v("在写复制操作符时，要避免复制自己。")])]),s._v(" "),n("p",[s._v("参考：")]),s._v(" "),n("p",[s._v("https://www.youtube.com/watch?v=4qhz7E59QBs&index=9&list=PLE28375D4AC946CC3")])])}],!1,null,null,null);r.options.__file="assignment_to_self_in_assignment_operator.md";a.default=r.exports}}]);